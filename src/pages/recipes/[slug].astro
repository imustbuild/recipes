---
import Layout from '@layouts/Layout.astro';
import Header from '@components/Header.astro';
import Footer from '@components/Footer.astro';
import Tag from '@components/Tag.astro';
import { loadAllRecipes, loadRecipe } from '@lib/recipes';
import { formatDuration } from '@lib/normalize';

export async function getStaticPaths() {
  const recipes = loadAllRecipes();
  return recipes.map(recipe => ({
    params: { slug: recipe.slug },
  }));
}

const { slug } = Astro.params;
const recipe = loadRecipe(slug as string);

if (!recipe) {
  return Astro.redirect('/recipes');
}

const prepTime = formatDuration(recipe.times.prep_minutes);
const cookTime = formatDuration(recipe.times.cook_minutes);
const totalTime = formatDuration(recipe.times.total_minutes);
---

<Layout title={`${recipe.title} · Recipes`} description={recipe.description}>
  <div class="min-h-screen flex flex-col">
    <Header currentPath="/recipes" />
    
    <main class="flex-1">
      <article class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Header -->
        <header class="mb-8">
          <a href="/recipes" class="inline-flex items-center gap-1 text-sm text-stone-500 hover:text-terracotta-600 mb-4 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            Back to recipes
          </a>
          
          <h1 class="font-display text-3xl sm:text-4xl lg:text-5xl font-semibold text-stone-900 mb-4">
            {recipe.title}
          </h1>
          
          {recipe.description && (
            <p class="text-lg text-stone-600 mb-6">{recipe.description}</p>
          )}
          
          {recipe.tags.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-6">
              {recipe.tags.map(tag => (
                <Tag tag={tag} />
              ))}
            </div>
          )}
          
          <!-- Meta -->
          <div class="flex flex-wrap gap-6 text-sm border-t border-b border-stone-200 py-4">
            {totalTime && (
              <div>
                <span class="text-stone-500">Total time</span>
                <p class="font-medium text-stone-900">{totalTime}</p>
              </div>
            )}
            {prepTime && (
              <div>
                <span class="text-stone-500">Prep</span>
                <p class="font-medium text-stone-900">{prepTime}</p>
              </div>
            )}
            {cookTime && (
              <div>
                <span class="text-stone-500">Cook</span>
                <p class="font-medium text-stone-900">{cookTime}</p>
              </div>
            )}
            <div>
              <span class="text-stone-500">Servings</span>
              <p class="font-medium text-stone-900">{recipe.servings}</p>
            </div>
            {recipe.source_url && (
              <div>
                <span class="text-stone-500">Source</span>
                <p>
                  <a href={recipe.source_url} target="_blank" rel="noopener noreferrer" class="font-medium text-terracotta-600 hover:text-terracotta-700">
                    Original recipe →
                  </a>
                </p>
              </div>
            )}
          </div>
        </header>
        
        <div class="grid lg:grid-cols-[1fr,2fr] gap-12">
          <!-- Ingredients -->
          {recipe.ingredients.length > 0 && (
            <section>
              <h2 class="font-display text-xl font-semibold text-stone-900 mb-4">Ingredients</h2>
              <ul class="space-y-2">
                {recipe.ingredients.map(ing => (
                  <li class="flex items-start gap-3 py-2 border-b border-stone-100 last:border-0">
                    <input type="checkbox" class="mt-1 rounded border-stone-300 text-terracotta-600 focus:ring-terracotta-500" />
                    <span>
                      {ing.amount && <span class="font-medium">{ing.amount}</span>}
                      {' '}{ing.item}
                      {ing.note && <span class="text-stone-500">, {ing.note}</span>}
                    </span>
                  </li>
                ))}
              </ul>
            </section>
          )}
          
          <!-- Instructions -->
          {recipe.instructions.length > 0 && (
            <section>
              <h2 class="font-display text-xl font-semibold text-stone-900 mb-4">Instructions</h2>
              <ol class="space-y-4">
                {recipe.instructions.map((step, i) => (
                  <li class="flex gap-4">
                    <span class="flex-shrink-0 w-8 h-8 rounded-full bg-terracotta-100 text-terracotta-700 font-semibold flex items-center justify-center text-sm">
                      {i + 1}
                    </span>
                    <p class="text-stone-700 pt-1">{step}</p>
                  </li>
                ))}
              </ol>
            </section>
          )}
        </div>
        
        <!-- Notes -->
        {recipe.notes && (
          <section class="mt-12 bg-cream-100 rounded-xl p-6">
            <h2 class="font-display text-lg font-semibold text-stone-900 mb-2">Notes</h2>
            <p class="text-stone-700">{recipe.notes}</p>
          </section>
        )}
        
        <!-- Body content (markdown) -->
        {recipe.body && (
          <section class="mt-12 prose prose-stone prose-terracotta max-w-none">
            <Fragment set:html={recipe.body} />
          </section>
        )}
      </article>
    </main>
    
    <Footer />
  </div>
</Layout>

<style>
  .prose-terracotta :where(a):not(:where([class~="not-prose"], [class~="not-prose"] *)) {
    color: var(--color-terracotta-600);
  }
</style>

